{% extends "base.html" %}

{% block title %}Playing - Villagers, Knights & Dragon{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Game Status Bar -->
    <div class="alert mb-6" id="game-status">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span id="status-text">
            {% if game.state.value == 'playing' %}
            Discussion Phase - Discuss to find the Dragon!
            {% elif game.state.value == 'voting' %}
            Voting Phase - Vote for who you think is the Dragon
            {% elif game.state.value == 'dragon_guess' %}
            Dragon is guessing the word...
            {% endif %}
        </span>
    </div>

    <!-- Elimination Notification -->
    <div id="elimination-notification" class="alert alert-warning mb-6" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <div id="elimination-text"></div>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column: Your Role -->
        <div>
            <!-- Your Role Card -->
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">Your Role</h2>

                    {% if player.role == 'dragon' %}
                    <div class="flex items-center gap-4 p-4 bg-error/10 rounded-lg border-2 border-error">
                        <div class="text-6xl">üêâ</div>
                        <div>
                            <h3 class="text-2xl font-bold text-error">Dragon</h3>
                            <p class="text-sm">You don't know the word! Blend in and survive.</p>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <span class="text-sm">The word is: <strong>???</strong></span>
                    </div>

                    {% elif player.role == 'knight' %}
                    <div class="flex items-center gap-4 p-4 bg-secondary/10 rounded-lg border-2 border-secondary">
                        <div class="text-6xl">‚öîÔ∏è</div>
                        <div>
                            <h3 class="text-2xl font-bold text-secondary">Knight</h3>
                            <p class="text-sm">Protect the villagers! Find the Dragon.</p>
                        </div>
                    </div>
                    <div class="alert alert-success mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-sm">The secret word is: <strong class="text-lg">{{ word }}</strong></span>
                    </div>

                    {% else %}
                    <div class="flex items-center gap-4 p-4 bg-success/10 rounded-lg border-2 border-success">
                        <div class="text-6xl">üèòÔ∏è</div>
                        <div>
                            <h3 class="text-2xl font-bold text-success">Villager</h3>
                            <p class="text-sm">Work together to find the Dragon!</p>
                        </div>
                    </div>
                    <div class="alert alert-success mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-sm">The secret word is: <strong class="text-lg">{{ word }}</strong></span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Host Controls -->
            {% if player.is_host and game.state.value == 'playing' %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title text-lg">Host Controls</h3>
                    <button
                        hx-post="/api/games/{{ game.game_id }}/start-voting?player_id={{ player_id }}"
                        hx-swap="none"
                        class="btn btn-warning btn-block">
                        Start Voting Round
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Players & Voting -->
        <div>
            <!-- Players Grid -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        Players
                        <div class="badge badge-primary" id="alive-count">
                            {{ game.players.values()|selectattr('is_alive')|list|length }} alive
                        </div>
                    </h2>

                    <div id="players-grid" class="grid grid-cols-2 gap-3 mt-4">
                        {% for p in game.players.values() %}
                        <div class="flex items-center gap-2 p-3 rounded-lg {% if p.is_alive %}bg-base-200{% else %}bg-base-300 opacity-50{% endif %}">
                            <div class="avatar placeholder">
                                <div class="bg-primary text-primary-content rounded-full w-10">
                                    <span>{{ p.nickname[0]|upper }}</span>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold truncate">{{ p.nickname }}</div>
                                {% if not p.is_alive %}
                                <div class="text-xs text-error">Eliminated</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Voting Area (Alive Players Only) -->
            <div id="voting-area" class="card bg-base-100 shadow-xl mt-6" style="{% if game.state.value != 'voting' or not player.is_alive %}display: none;{% endif %}">
                <div class="card-body">
                    <h2 class="card-title">Cast Your Vote</h2>
                    <p class="text-sm text-base-content/70 mb-4">Vote for who you think is the Dragon</p>

                    <div id="vote-buttons" class="space-y-2">
                        <!-- Vote buttons will be dynamically generated by JavaScript -->
                    </div>

                    <div id="vote-status" class="alert alert-info mt-4" style="display: none;">
                        <span>Vote submitted! Waiting for other players...</span>
                    </div>
                </div>
            </div>

            <!-- Spectator Message (Eliminated Players) -->
            <div id="spectator-message" class="card bg-base-100 shadow-xl mt-6" style="{% if player.is_alive %}display: none;{% endif %}">
                <div class="card-body">
                    <h2 class="card-title text-error">You Were Eliminated</h2>
                    <p class="text-base-content/70">You are now spectating the game. Watch as the remaining players try to find the Dragon!</p>
                    <div class="alert alert-info mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="spectator-status">Waiting for voting to complete...</span>
                    </div>
                </div>
            </div>

            <!-- Dragon Guess Area -->
            <div id="guess-area" class="card bg-base-100 shadow-xl mt-6" style="{% if player.role != 'dragon' or game.state.value != 'dragon_guess' %}display: none;{% endif %}">
                <div class="card-body">
                    <h2 class="card-title text-error">Final Chance!</h2>
                    <p class="text-sm mb-4">You've been eliminated. Guess the secret word to win!</p>

                    <form hx-post="/api/games/{{ game.game_id }}/guess-word?player_id={{ player_id }}" hx-swap="none">
                        <div class="form-control">
                            <input
                                type="text"
                                name="guess"
                                placeholder="Enter your guess..."
                                class="input input-bordered"
                                required
                                autofocus
                            />
                        </div>
                        <button type="submit" class="btn btn-primary btn-block mt-4">
                            Submit Guess
                        </button>
                    </form>
                </div>
            </div>

            <!-- Waiting for Dragon Guess (Non-Dragon Players) -->
            <div id="dragon-guessing-message" class="card bg-base-100 shadow-xl mt-6" style="{% if player.role == 'dragon' or game.state.value != 'dragon_guess' %}display: none;{% endif %}">
                <div class="card-body text-center">
                    <div class="text-6xl mb-4">üêâ</div>
                    <h2 class="card-title justify-center">Dragon is Guessing!</h2>
                    <p class="text-base-content/70">The Dragon has been eliminated but gets one chance to guess the secret word...</p>
                    <div class="loading loading-dots loading-lg mt-4"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Game page loaded');
    console.log('Game ID: {{ game.game_id }}');
    console.log('Player ID: {{ player_id }}');

    // Initialize native WebSocket connection
    initGameWebSocket('{{ game.game_id }}', '{{ player_id }}');
});

function updateStatusBar(state) {
    const statusText = document.getElementById('status-text');
    if (!statusText) return;

    const messages = {
        'playing': 'Discussion Phase - Discuss to find the Dragon!',
        'voting': 'Voting Phase - Vote for who you think is the Dragon',
        'dragon_guess': 'Dragon\'s Last Chance - Guessing the word...',
        'finished': 'Game Over!'
    };

    statusText.textContent = messages[state] || 'Game in progress';
}

function updatePlayersGrid(players) {
    const grid = document.getElementById('players-grid');
    if (!grid) return;

    grid.innerHTML = players.map(p => `
        <div class="flex items-center gap-2 p-3 rounded-lg ${p.is_alive ? 'bg-base-200' : 'bg-base-300 opacity-50'}">
            <div class="avatar placeholder">
                <div class="bg-primary text-primary-content rounded-full w-10">
                    <span>${p.nickname[0].toUpperCase()}</span>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <div class="font-semibold truncate">${p.nickname}</div>
                ${!p.is_alive ? '<div class="text-xs text-error">Eliminated</div>' : ''}
            </div>
        </div>
    `).join('');
}

function updateVoteButtons(players, gameId, yourId) {
    const voteButtons = document.getElementById('vote-buttons');
    if (!voteButtons) return;

    // Filter to only alive players (excluding yourself)
    const votablePlayers = players.filter(p => p.is_alive && p.id !== yourId);

    if (votablePlayers.length === 0) {
        voteButtons.innerHTML = '<p class="text-center text-base-content/70">No players available to vote for</p>';
        return;
    }

    voteButtons.innerHTML = votablePlayers.map(p => `
        <form hx-post="/api/games/${gameId}/vote?player_id=${yourId}" hx-swap="none">
            <input type="hidden" name="target_id" value="${p.id}">
            <button type="submit" class="btn btn-outline btn-error btn-block justify-start">
                <span class="avatar placeholder">
                    <div class="bg-primary text-primary-content rounded-full w-8">
                        <span class="text-sm">${p.nickname[0].toUpperCase()}</span>
                    </div>
                </span>
                Vote for ${p.nickname}
            </button>
        </form>
    `).join('');

    // Re-process HTMX for the new buttons
    if (typeof htmx !== 'undefined') {
        htmx.process(voteButtons);
    }
}
</script>
{% endblock %}
